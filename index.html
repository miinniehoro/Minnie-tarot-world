<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå & ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap" rel="stylesheet">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, collection, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCQaWNsVQ5YmNdp9QeSFvbdOqtBXYyuH9c",
            authDomain: "index-823d8.firebaseapp.com",
            projectId: "index-823d8",
            storageBucket: "index-823d8.firebasestorage.app",
            messagingSenderId: "325415376294",
            appId: "1:325415376294:web:2eeb267e5718b6f5266b67",
            measurementId: "G-7NDK3D96WM"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        setPersistence(auth, browserLocalPersistence);

        let currentUser = null;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const snap = await getDoc(doc(db, "users", user.uid));
                if (snap.exists()) {
                    const data = snap.data();
                    document.getElementById('p-img').src = data.img || 'https://via.placeholder.com/100';
                    document.getElementById('edit-nick').value = data.nickname || "";
                    document.getElementById('edit-bdate').value = data.birthdate || "";
                    if(data.birthdate) updateZodiacDisplay(data.birthdate);
                    
                    if (data.isPaid) {
                        document.getElementById('premium-tools').style.display = 'block';
                        document.getElementById('buy-premium-section').style.display = 'none';
                        document.getElementById('history-locked').style.display = 'none';
                        loadHistory(user.uid);
                    } else {
                        document.getElementById('premium-tools').style.display = 'none';
                        document.getElementById('buy-premium-section').style.display = 'block';
                        document.getElementById('history-locked').style.display = 'block';
                    }
                }
            } else { 
                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ Login ‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πâ‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
                window.location.href = 'index.html'; 
            }
        });

        window.updateZodiacDisplay = (dateStr) => {
            const zodiac = getZodiac(dateStr);
            document.getElementById('display-zodiac').innerText = "‡∏£‡∏≤‡∏®‡∏µ: " + zodiac;
        };

        window.saveProfile = async () => {
            const nick = document.getElementById('edit-nick').value;
            const bdate = document.getElementById('edit-bdate').value;
            const zodiac = getZodiac(bdate);
            try {
                await updateDoc(doc(db, "users", currentUser.uid), { nickname: nick, birthdate: bdate, zodiac: zodiac });
                alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!"); 
                window.location.href = 'index.html';
            } catch(e) { alert(e.message); }
        };

        window.uploadImg = (e) => {
            const reader = new FileReader();
            reader.onload = async (ev) => {
                await updateDoc(doc(db, "users", currentUser.uid), { img: ev.target.result });
                document.getElementById('p-img').src = ev.target.result;
            };
            reader.readAsDataURL(e.target.files[0]);
        };

        window.setTheme = async (url) => {
            await updateDoc(doc(db, "users", currentUser.uid), { bgTheme: url });
            alert("‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏•‡πâ‡∏ß!");
        };

        window.setCardColor = async (color) => {
            await updateDoc(doc(db, "users", currentUser.uid), { cardColor: color });
            alert("‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡πÑ‡∏û‡πà‡πÅ‡∏•‡πâ‡∏ß!");
        };

        async function loadHistory(uid) {
            const q = query(collection(db, "users", uid, "history"), orderBy("timestamp", "desc"), limit(5));
            const snaps = await getDocs(q);
            const list = document.getElementById('history-list'); list.innerHTML = "";
            snaps.forEach(d => {
                const h = d.data();
                list.innerHTML += `<div style="padding:10px; border-bottom:1px solid #eee; text-align:left;">
                    <small>${h.date}</small><br>
                    ${h.cards.map(c => `<img src="${c.i}" style="width:30px; margin:2px;">`).join("")}
                </div>`;
            });
        }

        function getZodiac(dateStr) {
            if(!dateStr) return "-"; const d = new Date(dateStr); const day = d.getDate(); const month = d.getMonth() + 1;
            if ((month == 3 && day >= 21) || (month == 4 && day <= 19)) return "‡πÄ‡∏°‡∏©";
            if ((month == 4 && day >= 20) || (month == 5 && day <= 20)) return "‡∏û‡∏§‡∏©‡∏†";
            if ((month == 5 && day >= 21) || (month == 6 && day <= 21)) return "‡πÄ‡∏°‡∏ñ‡∏∏‡∏ô";
            if ((month == 6 && day >= 22) || (month == 7 && day <= 22)) return "‡∏Å‡∏£‡∏Å‡∏é";
            if ((month == 7 && day >= 23) || (month == 8 && day <= 22)) return "‡∏™‡∏¥‡∏á‡∏´‡πå";
            if ((month == 8 && day >= 23) || (month == 9 && day <= 22)) return "‡∏Å‡∏±‡∏ô‡∏¢‡πå";
            if ((month == 9 && day >= 23) || (month == 10 && day <= 23)) return "‡∏ï‡∏∏‡∏•‡∏¢‡πå";
            if ((month == 10 && day >= 24) || (month == 11 && day <= 21)) return "‡∏û‡∏¥‡∏à‡∏¥‡∏Å";
            if ((month == 11 && day >= 22) || (month == 12 && day <= 21)) return "‡∏ò‡∏ô‡∏π";
            if ((month == 12 && day >= 22) || (month == 1 && day <= 19)) return "‡∏°‡∏±‡∏á‡∏Å‡∏£";
            if ((month == 1 && day >= 20) || (month == 2 && day <= 18)) return "‡∏Å‡∏∏‡∏°‡∏†‡πå";
            return "‡∏°‡∏µ‡∏ô";
        }
        window.logout = () => signOut(auth).then(() => location.href='index.html');
    </script>

    <style>
        body { font-family: 'Sarabun', sans-serif; background: #f5f5f5; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .card { background: white; width: 100%; max-width: 450px; border-radius: 20px; padding: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); text-align: center; }
        .p-img { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid #ad1457; aspect-ratio: 1/1; }
        input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 10px; font-family: 'Sarabun'; }
        .btn { padding: 12px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; width: 100%; margin: 5px 0; font-family: 'Sarabun'; }
        .btn-save { background: #ad1457; color: white; }
        .btn-premium { background: #ffd700; color: #1a237e; }
        .section-title { text-align: left; border-left: 4px solid #ad1457; padding-left: 10px; margin: 25px 0 10px; font-weight: bold; color: #ad1457; }
        .theme-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .theme-item { height: 60px; border-radius: 8px; cursor: pointer; background-size: cover; border: 1px solid #eee; background-color: #ddd; }
        .color-item { height: 40px; border-radius: 8px; cursor: pointer; border: 1px solid #ddd; }
        #display-zodiac { font-size: 18px; font-weight: bold; color: #ad1457; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="card">
        <label style="cursor: pointer;">
            <img id="p-img" class="p-img" src="https://via.placeholder.com/100">
            <input type="file" style="display:none" onchange="uploadImg(event)">
            <p style="font-size: 12px; color: #ad1457; margin-top: 5px;">‡πÅ‡∏ï‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ</p>
        </label>
        
        <div class="section-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</div>
        <input type="text" id="edit-nick" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô">
        <input type="date" id="edit-bdate" onchange="updateZodiacDisplay(this.value)">
        <div id="display-zodiac">‡∏£‡∏≤‡∏®‡∏µ: -</div>
        <button class="btn btn-save" onclick="saveProfile()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>

        <div id="buy-premium-section" style="margin-top: 20px; padding: 15px; background: #fff9e6; border-radius: 10px;">
            <p style="font-size: 14px; margin-bottom: 10px;">üíé ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏ò‡∏µ‡∏°‡∏û‡∏¥‡πÄ‡∏®‡∏©</p>
            <button class="btn btn-premium" onclick="window.open('https://line.me/ti/p/@yourid', '_blank')">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏û‡∏£‡∏µ‡πÄ‡∏°‡∏µ‡∏¢‡∏° (‡∏ó‡∏±‡∏Å‡πÅ‡∏ä‡∏ó)</button>
        </div>

        <div id="premium-tools" style="display: none;">
            <div class="section-title">‡∏û‡∏£‡∏µ‡πÄ‡∏°‡∏µ‡∏¢‡∏°‡∏Ñ‡∏±‡∏™‡∏ï‡∏≠‡∏°</div>
            <p style="text-align:left; font-size:12px;">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ß‡∏≠‡∏•‡πÄ‡∏õ‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ß‡πá‡∏ö:</p>
            <div class="theme-grid">
                <div class="theme-item" style="background: #F5F6F1;" onclick="setTheme('')"></div>
                <div class="theme-item" style="background-image: url('https://images.unsplash.com/photo-1534796636912-3b95b3ab5986?q=80&w=200');" onclick="setTheme('https://images.unsplash.com/photo-1534796636912-3b95b3ab5986?q=80&w=2071')"></div>
                <div class="theme-item" style="background-image: url('https://images.unsplash.com/photo-1518531933037-91b2f5f229cc?q=80&w=200');" onclick="setTheme('https://images.unsplash.com/photo-1518531933037-91b2f5f229cc?q=80&w=1854')"></div>
            </div>
            <p style="text-align:left; font-size:12px; margin-top:10px;">‡∏™‡∏µ‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏û‡πà:</p>
            <div class="theme-grid" style="grid-template-columns: repeat(4, 1fr);">
                <div class="color-item" style="background: #000;" onclick="setCardColor('#000')"></div>
                <div class="color-item" style="background: #4a148c;" onclick="setCardColor('#4a148c')"></div>
                <div class="color-item" style="background: #ad1457;" onclick="setCardColor('#ad1457')"></div>
                <div class="color-item" style="background: #1b5e20;" onclick="setCardColor('#1b5e20')"></div>
            </div>
        </div>

        <div class="section-title">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏î‡∏π‡∏î‡∏ß‡∏á</div>
        <div id="history-list"></div>
        <div id="history-locked" style="padding: 15px; color: #999; font-size: 12px; border: 1px dashed #ccc; border-radius: 10px;">
            üîí ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏ò‡∏µ‡∏°‡∏™‡∏á‡∏ß‡∏ô‡πÑ‡∏ß‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏û‡∏£‡∏µ‡πÄ‡∏°‡∏µ‡∏¢‡∏°
        </div>

        <button class="btn" style="margin-top: 20px; background: #eee;" onclick="location.href='index.html'">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
        <button class="btn" style="color: red; background: none; font-size: 14px;" onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>
</body>
</html>
